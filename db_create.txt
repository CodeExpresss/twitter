-- first only 3 command
CREATE DATABASE twitter WITH ENCODING = 'UTF8';
CREATE USER twitter_user WITH PASSWORD 'twitter_password';
ALTER ROLE twitter_user SUPERUSER;

-- connect to twitter before execution following commands
-- for psql:
-- \c twitter

CREATE TABLE users (
	id serial PRIMARY KEY, 
	password varchar(32), 
	email varchar(64), 
	is_active BOOLEAN, 
	session int,
	UNIQUE(email)
);

CREATE TABLE profile (
	id serial PRIMARY KEY,
	user_id serial,
	username varchar(64),
	avatar text,
	birthday date,
	CONSTRAINT profile_user FOREIGN KEY(user_id) REFERENCES users(id)
);

CREATE TABLE tweet (
	id serial PRIMARY KEY,
	profile_id serial,
	text varchar(140),
	create_date timestamp,
	image text ARRAY[4],
	is_visible BOOLEAN
);

CREATE TABLE comment (
    comment_id serial,
    tweet_id serial,
    CONSTRAINT pk_comment PRIMARY KEY(comment_id, tweet_id),
    CONSTRAINT comment FOREIGN KEY(comment_id) REFERENCES tweet(id),
    CONSTRAINT parent FOREIGN KEY(tweet_id) REFERENCES tweet(id)
);

CREATE TABLE tag (
	id serial PRIMARY KEY,
	text varchar(64)
);

CREATE TABLE tweet_tag (
	id serial PRIMARY KEY,
	tweet_id serial,
	tag_id serial,
	CONSTRAINT to_tweet FOREIGN KEY(tweet_id) REFERENCES tweet(id),
	CONSTRAINT to_tag FOREIGN KEY(tag_id) REFERENCES tag(id)
);

CREATE TABLE vote (
	profile_id serial,
	tweet_id serial,
	is_vote BOOLEAN,
	CONSTRAINT pk_vote PRIMARY KEY(profile_id, tweet_id),
	CONSTRAINT vote_profile FOREIGN KEY(profile_id) REFERENCES profile(id),
	CONSTRAINT vote_tweet FOREIGN KEY(tweet_id) REFERENCES tweet(id)
);

CREATE TABLE subscription (
	inviter_id serial,
	invitee_id serial,
	is_active BOOLEAN,
	CONSTRAINT pk_subscription PRIMARY KEY(inviter_id, invitee_id),
	CONSTRAINT inviter FOREIGN KEY(inviter_id) REFERENCES profile(id),
	CONSTRAINT invitee FOREIGN KEY(invitee_id) REFERENCES profile(id)
);

CREATE TYPE content as (
	tweet_id int,
	text varchar(140),
	create_date timestamp,
	image text ARRAY[4],
	tag varchar(64) ARRAY,
	username varchar(64),
	profile_id int,
	avatar text
);

CREATE TABLE newsfeed (
	id serial PRIMARY KEY,
	user_id serial,
	news content ARRAY
);

CREATE TABLE session (
    id varchar(32) PRIMARY KEY,
    user_id int,
    creation_date timestamp,
    CONSTRAINT user_unique FOREIGN key (user_id) references users(id)
);

create or replace function newsfeed_to_str(pid int)
returns table(p_id int, u_id int, tweet_id int, tweet_text varchar(140), tweet_date timestamp, images text[], tags varchar(64)[], username varchar(64), profile_id int, avatar text)
as $$
declare
	r record;
        news content;
begin
	for r in select * from newsfeed where id = pid
	loop
		foreach news in array r.news
                loop
                        return query select r.id, r.user_id, news.tweet_id, news.text, news.create_date, news.image, news.tag, news.username, news.profile_id, news.avatar;
                end loop;
	end loop;
end
$$ language plpgsql;

-- test data
insert into users values (1, 'password', 'myemail@mail.ru', true, 7);
insert into profile values (1, 1, 'user1', 'avatar', '2000-01-31');
insert into tweet values (1, 1, 'My first tweet', '2020-05-06 00:01', null, true);
insert into newsfeed values (1, 1, array[row(145, 'greate text', '2020-05-12',array[null], array['tag1'],'user1', 3, 'avatar')::content, row(1, 'another tweet', '2020-05-16', array[null], array['mytag'], 'user0', 5 , null)::content]);
